# Bheem Workspace - Alembic Database Migrations

This directory contains Alembic database migrations for version-controlled schema management.

## Quick Reference

### Check Current Version
```bash
cd backend
alembic current
```

### View Migration History
```bash
alembic history --verbose
```

### Create a New Migration

**Auto-generate from model changes (recommended):**
```bash
alembic revision --autogenerate -m "description_of_changes"
```

**Create empty migration for manual SQL:**
```bash
alembic revision -m "description_of_changes"
```

### Apply Migrations

**Upgrade to latest:**
```bash
alembic upgrade head
```

**Upgrade by specific steps:**
```bash
alembic upgrade +1   # One revision forward
alembic upgrade +2   # Two revisions forward
```

**Upgrade to specific revision:**
```bash
alembic upgrade <revision_id>
```

### Rollback Migrations

**Downgrade by steps:**
```bash
alembic downgrade -1   # One revision back
alembic downgrade -2   # Two revisions back
```

**Downgrade to specific revision:**
```bash
alembic downgrade <revision_id>
```

**Downgrade to base (dangerous!):**
```bash
alembic downgrade base
```

### Generate SQL Without Applying

**Preview upgrade SQL:**
```bash
alembic upgrade head --sql
```

**Preview downgrade SQL:**
```bash
alembic downgrade -1 --sql
```

## Migration Guidelines

### Naming Conventions
- Use descriptive, lowercase names with underscores
- Examples:
  - `add_user_preferences_table`
  - `add_email_column_to_tenants`
  - `create_notifications_index`

### Best Practices

1. **Always review autogenerated migrations** before running them
2. **Test migrations on staging** before production
3. **Keep migrations small and focused** - one logical change per migration
4. **Include both upgrade and downgrade** functions when possible
5. **Never modify existing migrations** that have been applied to production

### Schema Information

All Bheem Workspace tables are in the `workspace` schema:
- `workspace.tenants`
- `workspace.tenant_users`
- `workspace.meeting_rooms`
- etc.

The Alembic version table is stored in `workspace.alembic_version`.

## Directory Structure

```
alembic/
├── env.py              # Environment configuration (async SQLAlchemy)
├── script.py.mako      # Migration template
├── README.md           # This file
└── versions/           # Migration files
    └── 2026_01_28_*_initial_baseline.py
```

## Troubleshooting

### "Target database is not up to date"
Run `alembic upgrade head` to apply pending migrations.

### "Can't locate revision"
Check that the migration file exists in `alembic/versions/`.

### Connection issues
Verify DATABASE_URL in your `.env` file matches the target database.

## Legacy SQL Migrations

Previous manual SQL migrations are stored in `/backend/migrations/` (001-028).
These have been incorporated into the baseline. New changes should use Alembic.
